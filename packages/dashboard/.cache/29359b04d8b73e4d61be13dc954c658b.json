{"id":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","dependencies":[{"name":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/package.json","includedInParent":true,"mtime":1535727511817},{"name":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/package.json","includedInParent":true,"mtime":1535727539307},{"name":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/.babelrc","includedInParent":true,"mtime":1533206516246},{"name":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/.babelrc","includedInParent":true,"mtime":499162500000},{"name":"ipfs-api","loc":{"line":6,"column":43},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/node_modules/ipfs-api/src/index.js"},{"name":"os","loc":{"line":7,"column":37},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/os-browserify/browser.js"},{"name":"path","loc":{"line":8,"column":39},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/path-browserify/index.js"},{"name":"truffle-contract","loc":{"line":9,"column":51},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/truffle-contract/index.js"},{"name":"url-parse","loc":{"line":10,"column":44},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/url-parse/index.js"},{"name":"util","loc":{"line":11,"column":39},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/util/util.js"},{"name":"web3","loc":{"line":12,"column":39},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/web3/index.js"},{"name":"./audio","loc":{"line":13,"column":40},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/audio/index.js"},{"name":"./devices/cash","loc":{"line":14,"column":39},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/devices/cash.js"},{"name":"./devices/printer","loc":{"line":15,"column":42},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/devices/printer.js"},{"name":"./fs","loc":{"line":16,"column":37},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/fs/index.js"},{"name":"./log","loc":{"line":17,"column":38},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/log/index.js"},{"name":"./token","loc":{"line":18,"column":40},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/token/index.js"},{"name":"./track","loc":{"line":19,"column":40},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/track/index.js"},{"name":"./devices/lcd","loc":{"line":21,"column":54},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/devices/lcd.js"},{"name":"./devices/lcd-spoof","loc":{"line":21,"column":81},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/devices/lcd-spoof.js"},{"name":"./devices/relay","loc":{"line":22,"column":56},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/devices/relay.js"},{"name":"./devices/relay-spoof","loc":{"line":22,"column":85},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/devices/relay-spoof.js"},{"name":"@chaosmachine/core/build/contracts/Chaos.json","loc":{"line":35,"column":62},"parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/core/build/contracts/Chaos.json"},{"name":"process","parent":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/@chaosmachine/chaos.js/lib/machine/index.js","resolved":"/Users/osarrouy/Documents/devs/dapps/@distributedgallery/@chaosmachine/packages/dashboard/node_modules/process/browser.js"}],"generated":{"js":"var process = require(\"process\");\n\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst ipfs_api_1 = __importDefault(require(\"ipfs-api\"));\nconst os_1 = __importDefault(require(\"os\"));\nconst path_1 = __importDefault(require(\"path\"));\nconst truffle_contract_1 = __importDefault(require(\"truffle-contract\"));\nconst url_parse_1 = __importDefault(require(\"url-parse\"));\nconst util_1 = __importDefault(require(\"util\"));\nconst web3_1 = __importDefault(require(\"web3\"));\nconst audio_1 = __importDefault(require(\"./audio\"));\nconst cash_1 = __importDefault(require(\"./devices/cash\"));\nconst printer_1 = __importDefault(require(\"./devices/printer\"));\nconst fs_1 = __importDefault(require(\"./fs\"));\nconst log_1 = __importDefault(require(\"./log\"));\nconst token_1 = __importDefault(require(\"./token\"));\nconst track_1 = __importDefault(require(\"./track\"));\n/* tslint:disable:no-var-requires */\nconst LCD = os_1.default.type() === 'Linux' ? require('./devices/lcd') : require('./devices/lcd-spoof');\nconst Relay = os_1.default.type() === 'Linux' ? require('./devices/relay') : require('./devices/relay-spoof');\n/* tslint:enable:no-var-requires */\nfunction timeout(ms) {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n}\nclass Machine {\n    constructor({ contract = Machine.defaults.contract, devices = Machine.defaults.devices, ethereum = Machine.defaults.ethereum, ipfs = Machine.defaults.ipfs } = {}) {\n        // IPFS\n        const url = url_parse_1.default(ipfs);\n        this.ipfs = ipfs_api_1.default(url.hostname, url.port, { protocol: url.protocol.slice(0, -1) });\n        // web3\n        this.web3 = new web3_1.default(new web3_1.default.providers.HttpProvider(ethereum));\n        // abstraction\n        this.abstraction = truffle_contract_1.default(require('@chaosmachine/core/build/contracts/Chaos.json'));\n        this.abstraction.setProvider(new web3_1.default.providers.HttpProvider(ethereum));\n        // contract\n        this.contract = this.abstraction.at(contract);\n        // utils\n        this.fs = fs_1.default;\n        this.paths = {\n            log: path_1.default.join(os_1.default.homedir(), '.chaos', 'log'),\n            root: path_1.default.join(os_1.default.homedir(), '.chaos'),\n            tracks: path_1.default.join(os_1.default.homedir(), '.chaos', 'tracks')\n        };\n        // components\n        this.log = new log_1.default(this);\n        this.track = new track_1.default(this);\n        this.audio = new audio_1.default(this);\n        this.token = new token_1.default(this);\n        // devices\n        if (devices) {\n            try {\n                this.cash = new cash_1.default({ port: '/dev/cash' });\n                this.printer = new printer_1.default({ port: '/dev/printer' });\n                this.lcd = new LCD({ rs: 25, e: 24, data: [23, 17, 27, 22], cols: 16, rows: 2 });\n                this.fans = new Relay({ pin: 15 });\n                this.resistor = new Relay({ pin: 14 });\n                // initialization\n                this.fans.turnOn();\n                this.cash.on('ready', () => this.log.info('Cash ready'));\n                this.printer.on('ready', () => {\n                    this.log.info('Printer ready');\n                    this.printer.print('https://www.distributedgallery.com');\n                });\n                this.lcd.on('ready', () => {\n                    this.log.info('LCD ready');\n                    this.lcd.write('HI, CHAOS');\n                });\n                // event handling\n                this.printer.on('done', (data) => this.log.info('QRCode printed'));\n                this.cash.on('accepted', async () => {\n                    try {\n                        this.log.info('Bill burning');\n                        this.cash.ssp.disable();\n                        this.resistor.turnOn();\n                        this.lcd.write('BURNING BILL');\n                        await timeout(20000);\n                        this.resistor.turnOff();\n                        this.lcd.write('BURNING BILL');\n                        await timeout(5000);\n                        this.resistor.turnOn();\n                        this.lcd.write('BURNING BILL');\n                        await timeout(10000);\n                        this.resistor.turnOff();\n                        this.lcd.write('BURNING BILL');\n                        const token = this.token.generate();\n                        this.log.info('Generating token', { token: token.address });\n                        this.printer.printShort('https://chaos.distributedgallery.com/upload/' + token.privateKey);\n                        this.lcd.write('TAKE YOUR TICKET');\n                        await timeout(5000);\n                        this.lcd.write('WAIT FOR MINING');\n                        this.log.info('Registering token', { token: token.address });\n                        await this.token.register(token.address);\n                        this.log.info('Token registered', { token: token.address });\n                        this.lcd.write('HI, CHAOS');\n                        this.cash.ssp.enable();\n                    }\n                    catch (err) {\n                        this.log.error(err.toString());\n                    }\n                });\n            }\n            catch (err) {\n                this.log.error(err.toString());\n            }\n            // exit process nicely\n            process.on('SIGINT', () => {\n                // this.cash!.close()\n                // this.printer!.close()\n                // this.lcd!.close()\n                // this.fans!.close()\n                // this.resistor!.close()\n                process.exit(0);\n            });\n            process.on('uncaughtException', (err) => {\n                this.log.error(err.toString());\n            });\n            process.on('unhandledRejection', (reason, p) => {\n                this.log.error(reason);\n            });\n            process.on('exit', () => {\n                this.cash.close();\n                this.printer.close();\n                this.lcd.close();\n                this.fans.close();\n                this.resistor.close();\n            });\n        }\n    }\n    async start() {\n        if (!this.fs.exists(this.paths.root)) {\n            this.fs.mkdir(this.paths.root);\n        }\n        if (!this.fs.exists(this.paths.tracks)) {\n            this.fs.mkdir(this.paths.tracks);\n        }\n        const accounts = await util_1.default.promisify(this.web3.eth.getAccounts)();\n        this.address = accounts[0];\n        const event = this.contract.TokenGranted({}, { fromBlock: 'latest', toBlock: 'latest' });\n        event.watch(async (err, result) => {\n            if (err) {\n                this.log.error(err);\n            }\n            else {\n                this.log.info('Token granted', { machine: result.args.machine, token: result.args.token });\n                await this.audio.shuffle();\n            }\n        });\n    }\n}\n// defaults parameters\nMachine.defaults = {\n    contract: '0xcdf45df24d878dd7e564a72802ba23031acfac07',\n    devices: false,\n    ethereum: 'http://localhost:8545',\n    ipfs: 'https://ipfs.infura.io:5001'\n};\nexports.default = Machine;\n","map":{"mappings":[{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":1,"column":0},"generated":{"line":2,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":2,"column":0},"generated":{"line":3,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":3,"column":0},"generated":{"line":4,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":4,"column":0},"generated":{"line":5,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":5,"column":0},"generated":{"line":6,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":6,"column":0},"generated":{"line":7,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":7,"column":0},"generated":{"line":8,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":8,"column":0},"generated":{"line":9,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":9,"column":0},"generated":{"line":10,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":10,"column":0},"generated":{"line":11,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":11,"column":0},"generated":{"line":12,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":12,"column":0},"generated":{"line":13,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":13,"column":0},"generated":{"line":14,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":14,"column":0},"generated":{"line":15,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":15,"column":0},"generated":{"line":16,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":16,"column":0},"generated":{"line":17,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":17,"column":0},"generated":{"line":18,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":18,"column":0},"generated":{"line":19,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":19,"column":0},"generated":{"line":20,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":20,"column":0},"generated":{"line":21,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":21,"column":0},"generated":{"line":22,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":22,"column":0},"generated":{"line":23,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":23,"column":0},"generated":{"line":24,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":24,"column":0},"generated":{"line":25,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":25,"column":0},"generated":{"line":26,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":26,"column":0},"generated":{"line":27,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":27,"column":0},"generated":{"line":28,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":28,"column":0},"generated":{"line":29,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":29,"column":0},"generated":{"line":30,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":30,"column":0},"generated":{"line":31,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":31,"column":0},"generated":{"line":32,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":32,"column":0},"generated":{"line":33,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":33,"column":0},"generated":{"line":34,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":34,"column":0},"generated":{"line":35,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":35,"column":0},"generated":{"line":36,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":36,"column":0},"generated":{"line":37,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":37,"column":0},"generated":{"line":38,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":38,"column":0},"generated":{"line":39,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":39,"column":0},"generated":{"line":40,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":40,"column":0},"generated":{"line":41,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":41,"column":0},"generated":{"line":42,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":42,"column":0},"generated":{"line":43,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":43,"column":0},"generated":{"line":44,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":44,"column":0},"generated":{"line":45,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":45,"column":0},"generated":{"line":46,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":46,"column":0},"generated":{"line":47,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":47,"column":0},"generated":{"line":48,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":48,"column":0},"generated":{"line":49,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":49,"column":0},"generated":{"line":50,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":50,"column":0},"generated":{"line":51,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":51,"column":0},"generated":{"line":52,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":52,"column":0},"generated":{"line":53,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":53,"column":0},"generated":{"line":54,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":54,"column":0},"generated":{"line":55,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":55,"column":0},"generated":{"line":56,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":56,"column":0},"generated":{"line":57,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":57,"column":0},"generated":{"line":58,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":58,"column":0},"generated":{"line":59,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":59,"column":0},"generated":{"line":60,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":60,"column":0},"generated":{"line":61,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":61,"column":0},"generated":{"line":62,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":62,"column":0},"generated":{"line":63,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":63,"column":0},"generated":{"line":64,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":64,"column":0},"generated":{"line":65,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":65,"column":0},"generated":{"line":66,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":66,"column":0},"generated":{"line":67,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":67,"column":0},"generated":{"line":68,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":68,"column":0},"generated":{"line":69,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":69,"column":0},"generated":{"line":70,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":70,"column":0},"generated":{"line":71,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":71,"column":0},"generated":{"line":72,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":72,"column":0},"generated":{"line":73,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":73,"column":0},"generated":{"line":74,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":74,"column":0},"generated":{"line":75,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":75,"column":0},"generated":{"line":76,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":76,"column":0},"generated":{"line":77,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":77,"column":0},"generated":{"line":78,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":78,"column":0},"generated":{"line":79,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":79,"column":0},"generated":{"line":80,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":80,"column":0},"generated":{"line":81,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":81,"column":0},"generated":{"line":82,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":82,"column":0},"generated":{"line":83,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":83,"column":0},"generated":{"line":84,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":84,"column":0},"generated":{"line":85,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":85,"column":0},"generated":{"line":86,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":86,"column":0},"generated":{"line":87,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":87,"column":0},"generated":{"line":88,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":88,"column":0},"generated":{"line":89,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":89,"column":0},"generated":{"line":90,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":90,"column":0},"generated":{"line":91,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":91,"column":0},"generated":{"line":92,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":92,"column":0},"generated":{"line":93,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":93,"column":0},"generated":{"line":94,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":94,"column":0},"generated":{"line":95,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":95,"column":0},"generated":{"line":96,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":96,"column":0},"generated":{"line":97,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":97,"column":0},"generated":{"line":98,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":98,"column":0},"generated":{"line":99,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":99,"column":0},"generated":{"line":100,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":100,"column":0},"generated":{"line":101,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":101,"column":0},"generated":{"line":102,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":102,"column":0},"generated":{"line":103,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":103,"column":0},"generated":{"line":104,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":104,"column":0},"generated":{"line":105,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":105,"column":0},"generated":{"line":106,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":106,"column":0},"generated":{"line":107,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":107,"column":0},"generated":{"line":108,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":108,"column":0},"generated":{"line":109,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":109,"column":0},"generated":{"line":110,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":110,"column":0},"generated":{"line":111,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":111,"column":0},"generated":{"line":112,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":112,"column":0},"generated":{"line":113,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":113,"column":0},"generated":{"line":114,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":114,"column":0},"generated":{"line":115,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":115,"column":0},"generated":{"line":116,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":116,"column":0},"generated":{"line":117,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":117,"column":0},"generated":{"line":118,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":118,"column":0},"generated":{"line":119,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":119,"column":0},"generated":{"line":120,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":120,"column":0},"generated":{"line":121,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":121,"column":0},"generated":{"line":122,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":122,"column":0},"generated":{"line":123,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":123,"column":0},"generated":{"line":124,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":124,"column":0},"generated":{"line":125,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":125,"column":0},"generated":{"line":126,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":126,"column":0},"generated":{"line":127,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":127,"column":0},"generated":{"line":128,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":128,"column":0},"generated":{"line":129,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":129,"column":0},"generated":{"line":130,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":130,"column":0},"generated":{"line":131,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":131,"column":0},"generated":{"line":132,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":132,"column":0},"generated":{"line":133,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":133,"column":0},"generated":{"line":134,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":134,"column":0},"generated":{"line":135,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":135,"column":0},"generated":{"line":136,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":136,"column":0},"generated":{"line":137,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":137,"column":0},"generated":{"line":138,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":138,"column":0},"generated":{"line":139,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":139,"column":0},"generated":{"line":140,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":140,"column":0},"generated":{"line":141,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":141,"column":0},"generated":{"line":142,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":142,"column":0},"generated":{"line":143,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":143,"column":0},"generated":{"line":144,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":144,"column":0},"generated":{"line":145,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":145,"column":0},"generated":{"line":146,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":146,"column":0},"generated":{"line":147,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":147,"column":0},"generated":{"line":148,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":148,"column":0},"generated":{"line":149,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":149,"column":0},"generated":{"line":150,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":150,"column":0},"generated":{"line":151,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":151,"column":0},"generated":{"line":152,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":152,"column":0},"generated":{"line":153,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":153,"column":0},"generated":{"line":154,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":154,"column":0},"generated":{"line":155,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":155,"column":0},"generated":{"line":156,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":156,"column":0},"generated":{"line":157,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":157,"column":0},"generated":{"line":158,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":158,"column":0},"generated":{"line":159,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":159,"column":0},"generated":{"line":160,"column":0}},{"source":"node_modules/@chaosmachine/chaos.js/lib/machine/index.js","original":{"line":160,"column":0},"generated":{"line":161,"column":0}}],"sources":{"node_modules/@chaosmachine/chaos.js/lib/machine/index.js":"\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst ipfs_api_1 = __importDefault(require(\"ipfs-api\"));\nconst os_1 = __importDefault(require(\"os\"));\nconst path_1 = __importDefault(require(\"path\"));\nconst truffle_contract_1 = __importDefault(require(\"truffle-contract\"));\nconst url_parse_1 = __importDefault(require(\"url-parse\"));\nconst util_1 = __importDefault(require(\"util\"));\nconst web3_1 = __importDefault(require(\"web3\"));\nconst audio_1 = __importDefault(require(\"./audio\"));\nconst cash_1 = __importDefault(require(\"./devices/cash\"));\nconst printer_1 = __importDefault(require(\"./devices/printer\"));\nconst fs_1 = __importDefault(require(\"./fs\"));\nconst log_1 = __importDefault(require(\"./log\"));\nconst token_1 = __importDefault(require(\"./token\"));\nconst track_1 = __importDefault(require(\"./track\"));\n/* tslint:disable:no-var-requires */\nconst LCD = os_1.default.type() === 'Linux' ? require('./devices/lcd') : require('./devices/lcd-spoof');\nconst Relay = os_1.default.type() === 'Linux' ? require('./devices/relay') : require('./devices/relay-spoof');\n/* tslint:enable:no-var-requires */\nfunction timeout(ms) {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n}\nclass Machine {\n    constructor({ contract = Machine.defaults.contract, devices = Machine.defaults.devices, ethereum = Machine.defaults.ethereum, ipfs = Machine.defaults.ipfs } = {}) {\n        // IPFS\n        const url = url_parse_1.default(ipfs);\n        this.ipfs = ipfs_api_1.default(url.hostname, url.port, { protocol: url.protocol.slice(0, -1) });\n        // web3\n        this.web3 = new web3_1.default(new web3_1.default.providers.HttpProvider(ethereum));\n        // abstraction\n        this.abstraction = truffle_contract_1.default(require('@chaosmachine/core/build/contracts/Chaos.json'));\n        this.abstraction.setProvider(new web3_1.default.providers.HttpProvider(ethereum));\n        // contract\n        this.contract = this.abstraction.at(contract);\n        // utils\n        this.fs = fs_1.default;\n        this.paths = {\n            log: path_1.default.join(os_1.default.homedir(), '.chaos', 'log'),\n            root: path_1.default.join(os_1.default.homedir(), '.chaos'),\n            tracks: path_1.default.join(os_1.default.homedir(), '.chaos', 'tracks')\n        };\n        // components\n        this.log = new log_1.default(this);\n        this.track = new track_1.default(this);\n        this.audio = new audio_1.default(this);\n        this.token = new token_1.default(this);\n        // devices\n        if (devices) {\n            try {\n                this.cash = new cash_1.default({ port: '/dev/cash' });\n                this.printer = new printer_1.default({ port: '/dev/printer' });\n                this.lcd = new LCD({ rs: 25, e: 24, data: [23, 17, 27, 22], cols: 16, rows: 2 });\n                this.fans = new Relay({ pin: 15 });\n                this.resistor = new Relay({ pin: 14 });\n                // initialization\n                this.fans.turnOn();\n                this.cash.on('ready', () => this.log.info('Cash ready'));\n                this.printer.on('ready', () => {\n                    this.log.info('Printer ready');\n                    this.printer.print('https://www.distributedgallery.com');\n                });\n                this.lcd.on('ready', () => {\n                    this.log.info('LCD ready');\n                    this.lcd.write('HI, CHAOS');\n                });\n                // event handling\n                this.printer.on('done', (data) => this.log.info('QRCode printed'));\n                this.cash.on('accepted', async () => {\n                    try {\n                        this.log.info('Bill burning');\n                        this.cash.ssp.disable();\n                        this.resistor.turnOn();\n                        this.lcd.write('BURNING BILL');\n                        await timeout(20000);\n                        this.resistor.turnOff();\n                        this.lcd.write('BURNING BILL');\n                        await timeout(5000);\n                        this.resistor.turnOn();\n                        this.lcd.write('BURNING BILL');\n                        await timeout(10000);\n                        this.resistor.turnOff();\n                        this.lcd.write('BURNING BILL');\n                        const token = this.token.generate();\n                        this.log.info('Generating token', { token: token.address });\n                        this.printer.printShort('https://chaos.distributedgallery.com/upload/' + token.privateKey);\n                        this.lcd.write('TAKE YOUR TICKET');\n                        await timeout(5000);\n                        this.lcd.write('WAIT FOR MINING');\n                        this.log.info('Registering token', { token: token.address });\n                        await this.token.register(token.address);\n                        this.log.info('Token registered', { token: token.address });\n                        this.lcd.write('HI, CHAOS');\n                        this.cash.ssp.enable();\n                    }\n                    catch (err) {\n                        this.log.error(err.toString());\n                    }\n                });\n            }\n            catch (err) {\n                this.log.error(err.toString());\n            }\n            // exit process nicely\n            process.on('SIGINT', () => {\n                // this.cash!.close()\n                // this.printer!.close()\n                // this.lcd!.close()\n                // this.fans!.close()\n                // this.resistor!.close()\n                process.exit(0);\n            });\n            process.on('uncaughtException', (err) => {\n                this.log.error(err.toString());\n            });\n            process.on('unhandledRejection', (reason, p) => {\n                this.log.error(reason);\n            });\n            process.on('exit', () => {\n                this.cash.close();\n                this.printer.close();\n                this.lcd.close();\n                this.fans.close();\n                this.resistor.close();\n            });\n        }\n    }\n    async start() {\n        if (!this.fs.exists(this.paths.root)) {\n            this.fs.mkdir(this.paths.root);\n        }\n        if (!this.fs.exists(this.paths.tracks)) {\n            this.fs.mkdir(this.paths.tracks);\n        }\n        const accounts = await util_1.default.promisify(this.web3.eth.getAccounts)();\n        this.address = accounts[0];\n        const event = this.contract.TokenGranted({}, { fromBlock: 'latest', toBlock: 'latest' });\n        event.watch(async (err, result) => {\n            if (err) {\n                this.log.error(err);\n            }\n            else {\n                this.log.info('Token granted', { machine: result.args.machine, token: result.args.token });\n                await this.audio.shuffle();\n            }\n        });\n    }\n}\n// defaults parameters\nMachine.defaults = {\n    contract: '0xcdf45df24d878dd7e564a72802ba23031acfac07',\n    devices: false,\n    ethereum: 'http://localhost:8545',\n    ipfs: 'https://ipfs.infura.io:5001'\n};\nexports.default = Machine;\n"},"lineCount":161}},"hash":"a09227d842070b979498b1669ebbb70b","cacheData":{"env":{}}}